<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>Global Health and Life Expectancy</title>
</head>
<body onload="loadScene1()">
    <button class="nextbutton1" id="nextbutton1" onclick="loadScene2()">Next</button>
    <h1>
        <center>
            Life Expectancy Over Time
        </center>
    </h1>
    <div id="scene-container"></div>
    <script src="scene1.js"></script>
    <script src="scene2.js" defer></script>
    <script src="scene3.js" defer></script>
    <script>
        let currentScene = 0;
        const scenes = [loadScene1, loadScene2, loadScene3];

        function loadScene1() {
            document.getElementById('scene-container').innerHTML = '';
            d3.select("#scene-container").append("div").attr("id", "scene1-container");
            d3.select("#nextbutton1").setAttribute('onclick', 'loadScene2()');
            currentScene = 1;

            d3.csv("life_expectancy.csv").then(function(data) {
                data.forEach(d => {
                    d.Year = +d.Year;
                    d.Life_Expectancy = +d.Life_Expectancy;
                });

                var svg = d3.select("#scene1-container").append("svg").attr("width", 800).attr("height", 400);

                var x = d3.scaleLinear().domain([2010, 2019]).range([50, 750]);
                var y = d3.scaleLinear().domain([60, 80]).range([350, 50]);

                var line = d3.line().x(d => x(d.Year)).y(d => y(d.Life_Expectancy));
                var countries = [...new Set(data.map(d => d.Country))];

                countries.forEach(country => {
                    var countryData = data.filter(d => d.Country === country);

                    svg.append("path").datum(countryData).attr("fill", "none").attr("stroke", "steelblue").attr("stroke-width", 1.5).attr("d", line);

                    svg.selectAll(".dot").data(countryData).enter().append("circle").attr("class", "dot").attr("cx", d => x(d.Year)).attr("cy", d => y(d.Life_Expectancy)).attr("r", 5)
                        .on("mouseover", function(event, d) {
                            d3.select(this).attr("r", 8);
                            d3.select("#tooltip").style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 10) + "px").style("display", "inline-block")
                                .html(`Country: ${d.Country}<br>Year: ${d.Year}<br>Life Expectancy: ${d.Life_Expectancy}`);
                        })
                        .on("mouseout", function() {
                            d3.select(this).attr("r", 5);
                            d3.select("#tooltip").style("display", "none");
                        });
                });

                svg.append("text").attr("x", 400).attr("y", 30).attr("text-anchor", "middle").attr("class", "annotation").text("Life Expectancy Over Time");

                d3.select("body").append("div").attr("id", "tooltip").style("position", "absolute").style("text-align", "center").style("width", "120px").style("height", "50px").style("padding", "2px")
                    .style("font", "12px sans-serif").style("background", "lightsteelblue").style("border", "0px").style("border-radius", "8px").style("pointer-events", "none").style("display", "none");
            });
        }

        function loadScene2() {
            document.getElementById('scene-container').innerHTML = '';
            d3.select("#scene-container").append("div").attr("id", "scene2-container");
            d3.select("#nextbutton1").setAttribute('onclick', 'loadScene3()');
            d3.select("#nextbutton1").innerText = 'Next';
            currentScene = 2;

            d3.csv("healthcare_expenditure.csv").then(function(data) {
                data.forEach(d => {
                    d.Year = +d.Year;
                    d.Expenditure_Percentage_GDP = +d.Expenditure_Percentage_GDP;
                });

                var svg = d3.select("#scene2-container").append("svg").attr("width", 800).attr("height", 400);

                var selectedYear = 2019;
                var yearData = data.filter(d => d.Year === selectedYear);

                var x = d3.scaleBand().domain(yearData.map(d => d.Country)).range([50, 750]).padding(0.1);
                var y = d3.scaleLinear().domain([0, 20]).range([350, 50]);

                svg.selectAll(".bar").data(yearData).enter().append("rect").attr("class", "bar").attr("x", d => x(d.Country)).attr("y", d => y(d.Expenditure_Percentage_GDP))
                    .attr("width", x.bandwidth()).attr("height", d => 350 - y(d.Expenditure_Percentage_GDP)).attr("fill", "steelblue")
                    .on("mouseover", function(event, d) {
                        d3.select(this).attr("fill", "orange");
                        d3.select("#tooltip").style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 10) + "px").style("display", "inline-block")
                            .html(`Country: ${d.Country}<br>Expenditure: ${d.Expenditure_Percentage_GDP}%`);
                    })
                    .on("mouseout", function() {
                        d3.select(this).attr("fill", "steelblue");
                        d3.select("#tooltip").style("display", "none");
                    });

                svg.append("text").attr("x", 400).attr("y", 30).attr("text-anchor", "middle").attr("class", "annotation").text("Healthcare Expenditure by Country (2019)");

                d3.select("body").append("div").attr("id", "tooltip").style("position", "absolute").style("text-align", "center").style("width", "120px").style("height", "50px").style("padding", "2px")
                    .style("font", "12px sans-serif").style("background", "lightsteelblue").style("border", "0px").style("border-radius", "8px").style("pointer-events", "none").style("display", "none");
            });
        }

        function loadScene3() {
            document.getElementById('scene-container').innerHTML = '';
            d3.select("#scene-container").append("div").attr("id", "scene3-container");
            d3.select("#nextbutton1").setAttribute('onclick', '');
            d3.select("#nextbutton1").innerText = 'Next';
            currentScene = 3;

            d3.csv("mortality_rates.csv").then(function(data) {
                data.forEach(d => {
                    d.Year = +d.Year;
                    d.Deaths = +d.Deaths;
                });

                var svg = d3.select("#scene3-container").append("svg").attr("width", 800).attr("height", 400);

                var causes = [...new Set(data.map(d => d.Cause))];
                var nestedData = d3.nest()
                    .key(d => d.Country)
                    .key(d => d.Cause)
                    .rollup(leaves => d3.sum(leaves, d => d.Deaths))
                    .entries(data);

                var color = d3.scaleOrdinal(d3.schemeCategory10).domain(causes);
                var x = d3.scaleBand().domain(nestedData.map(d => d.key)).range([50, 750]).padding(0.1);
                var y = d3.scaleLinear().domain([0, d3.max(nestedData, d => d3.sum(d.values, v => v.value))]).range([350, 50]);

                svg.selectAll(".bar").data(nestedData).enter().append("g").attr("transform", d => `translate(${x(d.key)},0)`)
                    .each(function(d) {
                        var bars = d3.select(this).selectAll(".bar").data(d.values).enter().append("rect").attr("class", "bar")
                            .attr("x", d => x.bandwidth() / causes.length * causes.indexOf(d.key)).attr("y", d => y(d.value))
                            .attr("width", x.bandwidth() / causes.length).attr("height", d => 350 - y(d.value)).attr("fill", d => color(d.key))
                            .on("mouseover", function(event, d) {
                                d3.select(this).attr("fill", "orange");
                                d3.select("#tooltip").style("left", (event.pageX + 10) + "px").style("top", (event.pageY - 10) + "px").style("display", "inline-block")
                                    .html(`Country: ${d.key}<br>Cause: ${d.key}<br>Deaths: ${d.value}`);
                            })
                            .on("mouseout", function() {
                                d3.select(this).attr("fill", d => color(d.key));
                                d3.select("#tooltip").style("display", "none");
                            });
                    });

                svg.append("text").attr("x", 400).attr("y", 30).attr("text-anchor", "middle").attr("class", "annotation").text("Mortality Rates by Cause of Death (2010)");

                d3.select("body").append("div").attr("id", "tooltip").style("position", "absolute").style("text-align", "center").style("width", "120px").style("height", "50px").style("padding", "2px")
                    .style("font", "12px sans-serif").style("background", "lightsteelblue").style("border", "0px").style("border-radius", "8px").style("pointer-events", "none").style("display", "none");
            });
        }
    </script>
</body>
</html>
